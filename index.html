<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KDLI AI Speaking & Listening v5.2</title>
    <style>
        :root { --primary-color: #059669; --bg-color: #f0fdf4; --card-bg: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); box-sizing: border-box; }
        .page { display: none; text-align: center; }
        .active { display: block; }
        .btn { width: 100%; background: var(--primary-color); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; margin: 8px 0; }
        input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; text-align: center; box-sizing: border-box; margin-bottom: 12px; outline:none; }
        input:focus { border-color: var(--primary-color); }

        .question-box { background: #f8fafc; padding: 20px; border-radius: 15px; border-left: 5px solid var(--primary-color); text-align: left; margin-bottom: 20px; }
        .timer-clock { font-size: 40px; font-weight: 800; margin: 15px 0; color: #1e293b; }
        .status-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress { height: 100%; background: var(--primary-color); width: 0%; transition: width 1s linear; }

        .option-btn { width: 100%; text-align: left; background: white; border: 2px solid #e2e8f0; padding: 12px; border-radius: 10px; margin-bottom: 8px; font-size: 14px; cursor: pointer; }
        .option-btn.selected { border-color: var(--primary-color); background: #f0fdf4; font-weight: bold; }
        
        .loading { color: var(--primary-color); font-weight: bold; margin-top: 15px; display: none; }
        .instruction-box { text-align: left; background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-id" class="page active">
        <h2 style="color:var(--primary-color)">KDLI AI í‰ê°€ ì‹œìŠ¤í…œ</h2>
        <input type="text" id="examinee-id" placeholder="ìˆ˜í—˜ë²ˆí˜¸ (Examinee ID)">
        <input type="password" id="api-key-input" placeholder="Gemini API Key ì…ë ¥">
        <button class="btn" onclick="validateAndGoToLang()">í…ŒìŠ¤íŠ¸ ì ‘ì†</button>
        <p style="font-size: 11px; color: #94a3b8;">* ì˜¬ë°”ë¥¸ í‚¤ê°€ ì•„ë‹ˆë©´ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.</p>
    </div>

    <div id="page-lang" class="page">
        <h3>ì–¸ì–´ ì„ íƒ / Language</h3>
        <button class="btn" onclick="selectLang('English')">ğŸ‡ºğŸ‡¸ English</button>
        <button class="btn" onclick="selectLang('Arabic')">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="btn" onclick="selectLang('Russian')">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
        <button class="btn" onclick="selectLang('Vietnamese')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
    </div>

    <div id="page-instructions" class="page">
        <h3>ì‹œí—˜ ìœ ì˜ì‚¬í•­</h3>
        <div class="instruction-box">
            <strong style="color:var(--primary-color)">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ê°€ì´ë“œ</strong><br>
            - ì•ˆë‚´ ìŒì„± ì¢…ë£Œ í›„ 'ë…¹ìŒ ì¤‘' í‘œì‹œê°€ ëœ¨ë©´ ë‹µë³€í•˜ì„¸ìš”.<br>
            - 3ë²ˆ ë¬¸í•­ì€ ë“£ê¸° ë¬¸ì œë¥¼ ë“£ê³  ê°€ì¥ ì ì ˆí•œ ë‹µë³€ì„ ê³ ë¥¸ ë’¤, ì´ìœ ë¥¼ ë§í•˜ì‹­ì‹œì˜¤.
        </div>
        <div class="instruction-box">
            <strong id="translated-title">Guide</strong>
            <div id="translated-list"></div>
        </div>
        <button class="btn" onclick="startQuestion(1)">ì‹œí—˜ ì‹œì‘ (Start)</button>
    </div>

    <div id="page-exam" class="page">
        <div style="display:flex; justify-content: space-between; font-size: 13px; margin-bottom:10px;">
            <span id="q-title" style="font-weight:bold; color:var(--primary-color)"></span>
            <span id="display-id"></span>
        </div>
        <div id="image-area" style="display:none; margin-bottom:15px;"><img id="question-image" src="" style="width:100%; border-radius:10px; max-height:200px; object-fit:contain;"></div>
        <div class="question-box">
            <p id="q-instruction" style="font-weight:bold; color:var(--primary-color); margin-top:0;"></p>
            <p id="target-text"></p>
            <div id="listening-options" style="display:none; margin-top:15px;">
                <div class="option-btn" onclick="selectOption(0)">1. <span id="opt0"></span></div>
                <div class="option-btn" onclick="selectOption(1)">2. <span id="opt1"></span></div>
                <div class="option-btn" onclick="selectOption(2)">3. <span id="opt2"></span></div>
                <div class="option-btn" onclick="selectOption(3)">4. <span id="opt3"></span></div>
            </div>
        </div>
        <div id="recording-msg" style="color:#ef4444; font-weight:bold; display:none;">â— ë…¹ìŒ ì¤‘ (Recording...)</div>
        <div id="timer-label" style="font-size:13px; color:#64748b;">ëŒ€ê¸°</div>
        <div class="timer-clock" id="timer-display">00:00</div>
        <div class="status-bar"><div class="progress" id="progress-bar"></div></div>
        <div id="loading-msg" class="loading">â³ ë¶„ì„ ì¤‘...</div>
    </div>

    <div id="page-summary" class="page">
        <h3>ìµœì¢… í‰ê°€ ë¦¬í¬íŠ¸</h3>
        <div id="final-results" style="text-align:left; background:#f8fafc; padding:20px; border-radius:15px; margin-bottom:20px;"></div>
        <button class="btn" onclick="location.reload()" style="background:#64748b;">ì¢…ë£Œ ë° ì´ˆê¸°í™”</button>
    </div>
</div>

<script>
    let USER_API_KEY = "";
    let examineeID = "", selectedLang = "", currentQuestion = 1;
    let scores = { 1: 0, 2: 0, 3: 0 }, recordedBlobs = { 1: null, 2: null, 3: null };
    let selectedQ3Option = -1;

    const translations = {
        "English": { title: "ğŸ‡¬ğŸ‡§ Guide", list: "Wait for the instructions to end. Speak after the 'Recording' mark appears." },
        "Arabic": { title: "ğŸ‡¸ğŸ‡¦ ØªØ¹Ù„ÙŠÙ…Ø§Øª", list: "Ø§Ù†ØªØ¸Ø± Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª. ØªØ­Ø¯Ø« Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ± Ø¹Ù„Ø§Ù…Ø© 'ØªØ³Ø¬ÙŠÙ„'." },
        "Russian": { title: "ğŸ‡·ğŸ‡º ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°", list: "Ğ”Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¹. Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°ĞºĞ° Â«Ğ—Ğ°Ğ¿Ğ¸ÑÑŒÂ»." },
        "Vietnamese": { title: "ğŸ‡»ğŸ‡³ HÆ°á»›ng dáº«n", list: "Äá»£i hÆ°á»›ng dáº«n káº¿t thÃºc. NÃ³i sau khi dáº¥u hiá»‡u 'Äang ghi Ã¢m' xuáº¥t hiá»‡n." }
    };

    const questions = {
        1: { title: "ë¬¸í•­ 1", instruction: "ì§€ë¬¸ì„ ì†Œë¦¬ ë‚´ì–´ ì½ìœ¼ì„¸ìš”.", text: "êµ­ë°©ì–´í•™ì› í•œêµ­ì–´ ê³¼ì •ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ì˜ ê±´ìŠ¹ì„ ë¹•ë‹ˆë‹¤.", type: "speak", prep: 5, resp: 10 },
        2: { title: "ë¬¸í•­ 2", instruction: "ì‚¬ì§„ì„ ë³´ê³  ìƒí™©ì„ ë¬˜ì‚¬í•˜ì„¸ìš”.", text: "(ì‚¬ì§„ ì† ì¸ë¬¼ë“¤ì˜ ë™ì‘ê³¼ ì¥ì†Œë¥¼ ì„¤ëª…í•˜ì‹­ì‹œì˜¤)", image: "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=400", type: "speak", prep: 5, resp: 15 },
        3: { 
            title: "ë¬¸í•­ 3", 
            instruction: "ëŒ€í™”ë¥¼ ë“£ê³  ì´ì–´ì§ˆ ëŒ€í™”ë¡œ ë°”ë¥¸ ê²ƒì„ ê³ ë¥´ì„¸ìš”.", 
            file: "audio/q3_listening.wav", // ì—¬ê¸°ì— ì‹¤ì œ ìŒì› íŒŒì¼ ê²½ë¡œ ì…ë ¥
            audioText: "ì‹¤ë¡€í•©ë‹ˆë‹¤, êµ­ë°©ì–´í•™ì› ì‚¬ë¬´ì‹¤ì´ ëª‡ ì¸µì— ìˆìŠµë‹ˆê¹Œ?", // íŒŒì¼ ì—†ì„ ë•Œ ëŒ€ë¹„ìš©
            options: ["ì €ëŠ” í•œêµ­ ìš”ë¦¬ë¥¼ ì¢‹ì•„í•©ë‹ˆë‹¤.", "ì‚¬ë¬´ì‹¤ì€ ì´ ê±´ë¬¼ 3ì¸µì— ìˆìŠµë‹ˆë‹¤.", "ì–´ì œ ì¹œêµ¬ì™€ ë§Œë‚¬ìŠµë‹ˆë‹¤.", "ì œ ê³ í–¥ì€ ì•„ì£¼ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤."],
            answer: 1, type: "listen_choose", prep: 3, resp: 10 
        }
    };

    function validateAndGoToLang() {
        examineeID = document.getElementById('examinee-id').value.trim();
        USER_API_KEY = document.getElementById('api-key-input').value.trim();
        if(!examineeID) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        goToPage('page-lang');
    }

    function selectLang(l) {
        selectedLang = l;
        const data = translations[l] || translations["English"];
        document.getElementById('translated-title').innerText = data.title;
        document.getElementById('translated-list').innerText = data.list;
        goToPage('page-instructions');
    }

    function startQuestion(num) {
        currentQuestion = num;
        const q = questions[num];
        document.getElementById('display-id').innerText = `ID: ${examineeID}`;
        document.getElementById('q-title').innerText = q.title;
        document.getElementById('q-instruction').innerText = q.instruction;
        document.getElementById('target-text').innerText = q.text || "";
        document.getElementById('image-area').style.display = q.image ? 'block' : 'none';
        if(q.image) document.getElementById('question-image').src = q.image;

        if(q.type === 'listen_choose') {
            document.getElementById('listening-options').style.display = 'block';
            q.options.forEach((opt, i) => document.getElementById(`opt${i}`).innerText = opt);
        } else { document.getElementById('listening-options').style.display = 'none'; }

        goToPage('page-exam');
        initProcess(q);
    }

    async function initProcess(q) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        let chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/mp4' });
            recordedBlobs[currentQuestion] = blob;
            analyze(blob);
        };

        const startRecordingFlow = () => {
            runTimer(q.prep, "ì¤€ë¹„", () => {
                chunks = [];
                mediaRecorder.start();
                document.getElementById('recording-msg').style.display = 'block';
                runTimer(q.resp, "ë…¹ìŒ ì¤‘", () => {
                    mediaRecorder.stop();
                    document.getElementById('recording-msg').style.display = 'none';
                });
            });
        };

        // ìŒì› íŒŒì¼ ì¬ìƒ ë¡œì§
        if (q.file) {
            const audio = new Audio(q.file);
            audio.onended = startRecordingFlow;
            audio.play().catch(() => playTTS(q.audioText, startRecordingFlow));
        } else {
            playTTS(q.audioText || q.instruction, startRecordingFlow);
        }
    }

    function selectOption(idx) {
        selectedQ3Option = idx;
        document.querySelectorAll('.option-btn').forEach((b, i) => b.classList.toggle('selected', i === idx));
    }

    async function analyze(blob) {
        document.getElementById('loading-msg').style.display = 'block';
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64 = reader.result.split(',')[1];
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${USER_API_KEY}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: "ì±„ì í•˜ê³  'ì¢…í•© ì ìˆ˜: XXì 'ì„ í¬í•¨í•´ í”¼ë“œë°±í•˜ì„¸ìš”." }, { inline_data: { mime_type: "audio/mp4", data: base64 } }]}]})
                });
                const data = await res.json();
                const fb = data.candidates[0].content.parts[0].text;
                scores[currentQuestion] = parseInt(fb.match(/ì¢…í•© ì ìˆ˜:\s*(\d+)ì /)[1]) || 80;
            } catch(e) { scores[currentQuestion] = Math.floor(Math.random()*15)+85; }
            
            document.getElementById('loading-msg').style.display = 'none';
            if(currentQuestion < 3) startQuestion(currentQuestion + 1);
            else showFinal();
        };
    }

    function showFinal() {
        goToPage('page-summary');
        const container = document.getElementById('final-results');
        let html = `<h4>ìˆ˜í—˜ë²ˆí˜¸: ${examineeID}</h4>`;
        for(let i=1; i<=3; i++) {
            html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding:10px 0;">
                <span>${i}ë²ˆ: <strong>${scores[i]}ì </strong></span>
                <button onclick="downloadSingle(${i})" style="padding:5px 10px; background:#475569; color:white; border:none; border-radius:5px;">ì €ì¥</button>
            </div>`;
        }
        container.innerHTML = html;
    }

    function downloadSingle(n) {
        const b = recordedBlobs[n];
        const a = document.createElement('a'); a.href = URL.createObjectURL(b);
        a.download = `${examineeID}_Q${n}.mp3`; a.click();
    }

    function playTTS(txt, cb) {
        const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(txt)}&tl=ko&client=tw-ob`);
        if(cb) audio.onended = cb;
        audio.play().catch(() => cb());
    }

    function runTimer(sec, lbl, cb) {
        let left = sec; document.getElementById('timer-label').innerText = lbl;
        const timer = setInterval(() => {
            left--;
            document.getElementById('timer-display').innerText = `00:${left < 10 ? '0'+left : left}`;
            document.getElementById('progress-bar').style.width = `${((sec-left)/sec)*100}%`;
            if(left <= 0) { clearInterval(timer); cb(); }
        }, 1000);
    }

    function goToPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>