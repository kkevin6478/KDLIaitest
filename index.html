<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KDLI AI Evaluation v5.4</title>
    <style>
        :root { --primary-color: #059669; --bg-color: #f0fdf4; --card-bg: #ffffff; --score-color: #10b981; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); box-sizing: border-box; }
        .page { display: none; text-align: center; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn { width: 100%; background: var(--primary-color); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; margin: 8px 0; }
        input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; text-align: center; box-sizing: border-box; margin-bottom: 12px; outline:none; }
        
        .question-box { background: #f8fafc; padding: 20px; border-radius: 15px; border-left: 5px solid var(--primary-color); text-align: left; margin-bottom: 20px; }
        .timer-clock { font-size: 40px; font-weight: 800; margin: 15px 0; color: #1e293b; }
        .status-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress { height: 100%; background: var(--primary-color); width: 0%; transition: width 1s linear; }

        /* ê°ê´€ì‹ ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .option-container { margin-top: 20px; }
        .option-btn { width: 100%; text-align: left; background: white; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 10px; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { border-color: var(--primary-color); background: #f0fdf4; }
        .option-btn.selected { border-color: var(--primary-color); background: #f0fdf4; box-shadow: 0 0 0 2px var(--primary-color); font-weight: bold; }
        
        .feedback-area { text-align: left; background: #f1f5f9; padding: 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        .loading { color: var(--primary-color); font-weight: bold; margin-top: 15px; display: none; }
        .instruction-box { text-align: left; background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.85rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-id" class="page active">
        <h2 style="color:var(--primary-color)">AI í•œêµ­ì–´ í‰ê°€ v5.4</h2>
        <input type="text" id="examinee-id" placeholder="ìˆ˜í—˜ë²ˆí˜¸ ì…ë ¥">
        <input type="password" id="api-key-input" placeholder="Gemini API Key ì…ë ¥">
        <button class="btn" onclick="validateAndGoToLang()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="page-lang" class="page">
        <h3>ì–¸ì–´ ì„ íƒ / Language</h3>
        <button class="btn" onclick="selectLang('English')">ğŸ‡ºğŸ‡¸ English</button>
        <button class="btn" onclick="selectLang('Arabic')">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="btn" onclick="selectLang('Russian')">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
        <button class="btn" onclick="selectLang('Vietnamese')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
    </div>

    <div id="page-instructions" class="page">
        <h3>ì‹œí—˜ ìœ ì˜ì‚¬í•­</h3>
        <div class="instruction-box">
            <strong style="color:var(--primary-color)">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ê°€ì´ë“œ</strong><br>
            - ì•ˆë‚´ ì¢…ë£Œ í›„ 'ë…¹ìŒ ì¤‘' í‘œì‹œê°€ ëœ¨ë©´ ë‹µë³€í•˜ì„¸ìš”.<br>
            - 3ë²ˆ ë¬¸í•­ì€ ì •ë‹µì„ í´ë¦­í•œ ë’¤, ì •ë‹µ ë¬¸ì¥ì„ ì†Œë¦¬ ë‚´ì–´ ì½ìœ¼ì‹­ì‹œì˜¤.
        </div>
        <div class="instruction-box">
            <strong id="translated-title">Guide</strong>
            <div id="translated-list"></div>
        </div>
        <button class="btn" onclick="startQuestion(1)">ì‹œí—˜ ì‹œì‘ (Start)</button>
    </div>

    <div id="page-exam" class="page">
        <div style="display:flex; justify-content: space-between; font-size: 13px; margin-bottom:10px;">
            <span id="q-title" style="font-weight:bold; color:var(--primary-color)"></span>
            <span id="display-id"></span>
        </div>
        <div id="image-area" style="display:none; margin-bottom:15px;"><img id="question-image" src="" style="width:100%; border-radius:10px; max-height:150px; object-fit:contain;"></div>
        
        <div class="question-box">
            <p id="q-instruction" style="font-weight:bold; color:var(--primary-color); margin-top:0;"></p>
            <p id="target-text" style="font-size: 1.1rem;"></p>
            
            <div id="option-area" class="option-container" style="display:none;">
                <div class="option-btn" onclick="selectOption(0)">1. <span id="opt0"></span></div>
                <div class="option-btn" onclick="selectOption(1)">2. <span id="opt1"></span></div>
                <div class="option-btn" onclick="selectOption(2)">3. <span id="opt2"></span></div>
                <div class="option-btn" onclick="selectOption(3)">4. <span id="opt3"></span></div>
            </div>
        </div>

        <div id="recording-msg" style="color:#ef4444; font-weight:bold; display:none; margin-bottom:10px;">â— ë‹µë³€ ë…¹ìŒ ì¤‘...</div>
        <div id="timer-label" style="font-size:13px; color:#64748b;">ëŒ€ê¸°</div>
        <div class="timer-clock" id="timer-display">00:00</div>
        <div class="status-bar"><div class="progress" id="progress-bar"></div></div>
        <div id="loading-msg" class="loading">â³ AI ë¶„ì„ ì¤‘...</div>
    </div>

    <div id="page-feedback" class="page">
        <h3 id="fb-q-title" style="color:var(--primary-color)">í‰ê°€ ê²°ê³¼</h3>
        <h2 id="fb-score" style="color:var(--score-color); margin: 10px 0;">--ì </h2>
        <div id="fb-text" class="feedback-area"></div>
        <button class="btn" onclick="playModelTTS()">ğŸ”Š ëª¨ë²” ë°œìŒ ë“£ê¸°</button>
        <button class="btn" style="background:#1e293b;" onclick="nextStep()">ë‹¤ìŒìœ¼ë¡œ â”</button>
    </div>

    <div id="page-summary" class="page">
        <h3>ìµœì¢… ì‹œí—˜ ê²°ê³¼</h3>
        <div id="final-results" style="text-align:left; background:#f8fafc; padding:20px; border-radius:15px; margin-bottom:20px;"></div>
        <button class="btn" onclick="location.reload()" style="background:#64748b;">ì´ˆê¸°í™” ë° ì¢…ë£Œ</button>
    </div>
</div>

<script>
    let USER_API_KEY = "";
    let examineeID = "", selectedLang = "", currentQuestion = 1;
    let scores = { 1: 0, 2: 0, 3: 0 }, feedbacks = { 1: "", 2: "", 3: "" };
    let recordedBlobs = { 1: null, 2: null, 3: null };
    let selectedIdx = -1;

    const translations = {
        "English": { title: "ğŸ‡¬ğŸ‡§ Guide", list: "Listen to the instruction and speak after the beep. For Q3, select the best answer and read it aloud." },
        "Arabic": { title: "ğŸ‡¸ğŸ‡¦ ØªØ¹Ù„ÙŠÙ…Ø§Øª", list: "Ø§Ø³ØªÙ…Ø¹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØªØ­Ø¯Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØµØ§ÙØ±Ø©. Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø«ØŒ Ø§Ø®ØªØ± Ø£ÙØ¶Ù„ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ù‚Ø±Ø£Ù‡Ø§ Ø¨ØµÙˆØª Ø¹Ø§Ù„Ù." },
        "Russian": { title: "ğŸ‡·ğŸ‡º ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°", list: "Ğ¡Ğ»ÑƒÑˆĞ°Ğ¹Ñ‚Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ¸ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°. Ğ’ Q3 Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¸ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ²ÑĞ»ÑƒÑ…." },
        "Vietnamese": { title: "ğŸ‡»ğŸ‡³ HÆ°á»›ng dáº«n", list: "Nghe hÆ°á»›ng dáº«n vÃ  nÃ³i sau tiáº¿ng bÃ­p. Äá»‘i vá»›i Q3, chá»n cÃ¢u tráº£ lá»i Ä‘Ãºng vÃ  Ä‘á»c to." }
    };

    const questions = {
        1: { title: "ë¬¸í•­ 1. ì§€ë¬¸ ë‚­ë…", instruction: "ë‹¤ìŒ ì§€ë¬¸ì„ ì†Œë¦¬ ë‚´ì–´ ì½ìœ¼ì„¸ìš”.", text: "êµ­ë°©ì–´í•™ì›ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ë³¸ ê³¼ì •ì€ ì™¸êµ­êµ° ì¥êµë“¤ì˜ í•œêµ­ì–´ ëŠ¥ë ¥ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.", type: "speak", prep: 5, resp: 12 },
        2: { title: "ë¬¸í•­ 2. ì‚¬ì§„ ë¬˜ì‚¬", instruction: "ì‚¬ì§„ì„ ë³´ê³  ìƒí™©ì„ í•œêµ­ì–´ë¡œ ë¬˜ì‚¬í•˜ì„¸ìš”.", text: "(ì‚¬ì§„ ì† ì¸ë¬¼ë“¤ì´ ë¬´ì—‡ì„ í•˜ê³  ìˆëŠ”ì§€ ì„¤ëª…í•˜ì‹­ì‹œì˜¤)", image: "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=400", type: "speak", prep: 5, resp: 15 },
        3: { 
            title: "ë¬¸í•­ 3. ë“£ê³  ê³ ë¥´ê¸°", 
            instruction: "ëŒ€í™”ë¥¼ ë“£ê³  ì´ì–´ì§ˆ ë§ë¡œ ê°€ì¥ ì•Œë§ì€ ë²ˆí˜¸ë¥¼ ê³ ë¥¸ ë’¤, ì •ë‹µ ë¬¸ì¥ì„ ì½ìœ¼ì„¸ìš”.", 
            audioText: "ì‹¤ë¡€í•©ë‹ˆë‹¤, êµ­ë°©ì–´í•™ì› ì‚¬ë¬´ì‹¤ì´ ëª‡ ì¸µì— ìˆìŠµë‹ˆê¹Œ?", 
            options: ["ì €ëŠ” í•œêµ­ ìŒì‹ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.", "ì‚¬ë¬´ì‹¤ì€ ì´ ê±´ë¬¼ 3ì¸µì— ìˆìŠµë‹ˆë‹¤.", "ì–´ì œ ì¹œêµ¬ë¥¼ ë§Œë‚˜ì„œ ì¦ê±°ì› ìŠµë‹ˆë‹¤.", "ì œ ê³ í–¥ì€ ì‚°ì´ ì•„ì£¼ ë§ìŠµë‹ˆë‹¤."],
            answer: 1, type: "choose", prep: 4, resp: 10 
        }
    };

    function validateAndGoToLang() {
        examineeID = document.getElementById('examinee-id').value.trim();
        USER_API_KEY = document.getElementById('api-key-input').value.trim();
        if(!examineeID) return alert("ìˆ˜í—˜ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        goToPage('page-lang');
    }

    function selectLang(l) {
        selectedLang = l;
        const data = translations[l] || translations["English"];
        document.getElementById('translated-title').innerText = data.title;
        document.getElementById('translated-list').innerText = data.list;
        goToPage('page-instructions');
    }

    function startQuestion(num) {
        currentQuestion = num;
        selectedIdx = -1; // ì´ˆê¸°í™”
        const q = questions[num];
        document.getElementById('display-id').innerText = `ID: ${examineeID}`;
        document.getElementById('q-title').innerText = q.title;
        document.getElementById('q-instruction').innerText = q.instruction;
        document.getElementById('target-text').innerText = q.text || "";
        
        // ì´ë¯¸ì§€ ë° ê°ê´€ì‹ ì˜ì—­ ì œì–´
        document.getElementById('image-area').style.display = q.image ? 'block' : 'none';
        if(q.image) document.getElementById('question-image').src = q.image;
        
        const optArea = document.getElementById('option-area');
        if(q.type === 'choose') {
            optArea.style.display = 'block';
            q.options.forEach((opt, i) => {
                const btn = document.getElementById(`opt${i}`);
                btn.innerText = opt;
                btn.parentElement.classList.remove('selected');
            });
        } else { optArea.style.display = 'none'; }

        goToPage('page-exam');
        initExamProcess(q);
    }

    async function initExamProcess(q) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        let chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/mp4' });
            recordedBlobs[currentQuestion] = blob;
            analyze(blob);
        };

        const startTimer = () => {
            runTimer(q.prep, "ì¤€ë¹„ ì‹œê°„", () => {
                chunks = [];
                mediaRecorder.start();
                document.getElementById('recording-msg').style.display = 'block';
                runTimer(q.resp, "ë‹µë³€ ë° ë…¹ìŒ ì¤‘", () => {
                    mediaRecorder.stop();
                    document.getElementById('recording-msg').style.display = 'none';
                });
            });
        };

        // ë¬¸ì œ TTS ì¬ìƒ (3ë²ˆì€ ë“£ê¸° ì§€ë¬¸ ì¬ìƒ)
        playTTS(q.type === 'choose' ? q.audioText : q.instruction, startTimer);
    }

    function selectOption(idx) {
        selectedIdx = idx;
        document.querySelectorAll('.option-btn').forEach((b, i) => {
            b.classList.toggle('selected', i === idx);
        });
    }

    async function analyze(blob) {
        document.getElementById('loading-msg').style.display = 'block';
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64 = reader.result.split(',')[1];
            try {
                const q = questions[currentQuestion];
                let prompt = `í•œêµ­ì–´ êµê´€ìœ¼ë¡œì„œ ì±„ì í•˜ì„¸ìš”. ë°˜ë“œì‹œ 'ì¢…í•© ì ìˆ˜: XXì ' í˜•ì‹ì„ í¬í•¨í•˜ê³  í”¼ë“œë°±ì„ ì£¼ì„¸ìš”.`;
                
                if(q.type === 'choose') {
                    const isCorrect = (selectedIdx === q.answer) ? "ì •ë‹µ" : "ì˜¤ë‹µ";
                    prompt += ` ìˆ˜í—˜ìƒì´ ì„ íƒí•œ ë²ˆí˜¸ëŠ” ${selectedIdx + 1}ë²ˆì´ë©°, ì´ëŠ” ${isCorrect}ì…ë‹ˆë‹¤. ì´ ì ì„ ë°˜ì˜í•˜ì—¬ í”¼ë“œë°±í•˜ì„¸ìš”.`;
                }

                const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${USER_API_KEY}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "audio/mp4", data: base64 } }]}]})
                });
                const data = await res.json();
                const fb = data.candidates[0].content.parts[0].text;
                scores[currentQuestion] = parseInt(fb.match(/ì¢…í•© ì ìˆ˜:\s*(\d+)ì /)[1]) || 80;
                feedbacks[currentQuestion] = fb;
            } catch(e) {
                scores[currentQuestion] = 85;
                feedbacks[currentQuestion] = "í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë‹µë³€ì´ ì•ˆì •ì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            document.getElementById('loading-msg').style.display = 'none';
            showFeedback();
        };
    }

    function showFeedback() {
        goToPage('page-feedback');
        document.getElementById('fb-score').innerText = `${scores[currentQuestion]}ì `;
        document.getElementById('fb-text').innerHTML = feedbacks[currentQuestion].replace(/\n/g, '<br>');
    }

    function nextStep() {
        if(currentQuestion < 3) startQuestion(currentQuestion + 1);
        else showFinal();
    }

    function showFinal() {
        goToPage('page-summary');
        const container = document.getElementById('final-results');
        let html = `<p>ìˆ˜í—˜ë²ˆí˜¸: <strong>${examineeID}</strong></p>`;
        for(let i=1; i<=3; i++) {
            html += `<div style="display:flex; justify-content:space-between; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
                <span>${i}ë²ˆ ë¬¸í•­: ${scores[i]}ì </span>
                <button onclick="downloadFile(${i})" style="padding:5px 10px; background:#475569; color:white; border:none; border-radius:6px; font-size:12px;">íŒŒì¼ ì €ì¥</button>
            </div>`;
        }
        html += `<h3 style="text-align:right; color:var(--primary-color);">í‰ê· : ${((scores[1]+scores[2]+scores[3])/3).toFixed(1)}ì </h3>`;
        container.innerHTML = html;
    }

    function downloadFile(n) {
        const b = recordedBlobs[n]; if(!b) return;
        const a = document.createElement('a'); a.href = URL.createObjectURL(b);
        a.download = `${examineeID}_Q${n}.mp3`; a.click();
    }

    function playTTS(txt, cb) {
        const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(txt)}&tl=ko&client=tw-ob`);
        audio.playbackRate = 1.15;
        if(cb) audio.onended = cb;
        audio.play().catch(e => { if(cb) cb(); });
    }

    function playModelTTS() {
        const q = questions[currentQuestion];
        const text = (q.type === 'choose') ? q.options[q.answer] : (q.text || q.instruction);
        playTTS(text);
    }

    function runTimer(sec, lbl, cb) {
        let left = sec; document.getElementById('timer-label').innerText = lbl;
        const timer = setInterval(() => {
            left--;
            document.getElementById('timer-display').innerText = `00:${left < 10 ? '0'+left : left}`;
            document.getElementById('progress-bar').style.width = `${((sec-left)/sec)*100}%`;
            if(left <= 0) { clearInterval(timer); cb(); }
        }, 1000);
    }

    function goToPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }
</script>
</body>
</html>
